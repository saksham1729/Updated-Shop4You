{% extends 'app/base.html' %}
{% load static %}
{% block title %}Checkout{% endblock title %}

{% block main-content %}
<div class="container">
  <div class="row mt-5">

    <!-- Order Summary -->
    <div class="col-sm-6 text-body">
      <h4 class="text-body">Order Summary</h4>
      <hr class="border-secondary">
      {% for item in cart_items %}
        <div class="card mb-2 bg-body text-body border-0 shadow-sm">
          <div class="card-body">
            <h5>Product: {{ item.product.title }}</h5>
            <p>Quantity: {{ item.quantity }}</p>
            <p class="fw-bold">Price: â‚¹{{ item.total_cost }}</p>
          </div>
        </div>
      {% endfor %}
      <small class="text-secondary">Terms and Conditions: Lorem ipsum dolor sit amet consectetur adipisicing elit. Mollitia, ullam saepe! Iure optio repellat dolor velit, minus rem. Facilis cumque neque numquam laboriosam, accusantium adipisci nisi nihil in et quis?</small>
    </div>

    <!-- Shipping Address & Payment -->
    <div class="col-sm-4 offset-sm-1 text-body">
      <h4 class="text-body">Select Shipping Address</h4>
      <hr class="border-secondary">
      <form id="payment-form">
        {% for ad in add %}
          <div class="card mb-2 bg-body text-body border-0 shadow-sm">
            <div class="card-body">
              <h5>{{ ad.name }}</h5>
              <p>{{ ad.locality }}, {{ ad.city }}, {{ ad.state }} - {{ ad.zipcode }}</p>
              <div class="form-check mt-2">
                <input class="form-check-input" type="radio" name="custid" id="custadd{{ forloop.counter }}" value="{{ ad.id }}">
                <label class="form-check-label fw-bold" for="custadd{{ forloop.counter }}">
                  Address {{ forloop.counter }}
                </label>
              </div>
            </div>
          </div>
        {% endfor %}

        <button id="checkout-button" type="button" class="btn btn-primary mt-3 w-100">
          Pay with Stripe
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe("{{ stripe_publishable_key }}");

  document.getElementById('checkout-button').addEventListener('click', () => {
    const selectedAddress = document.querySelector('input[name="custid"]:checked');
    if (!selectedAddress) {
      alert('Please select a shipping address.');
      return;
    }

    fetch('/create-checkout-session/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        custid: selectedAddress.value
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        alert(data.error);
      } else {
        return stripe.redirectToCheckout({ sessionId: data.id });
      }
    })
    .catch(error => {
      console.error('Stripe Checkout error:', error);
      alert('There was an error initiating payment. Please try again.');
    });
  });
</script>
{% endblock main-content %}
