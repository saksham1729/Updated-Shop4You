{% extends 'app/base.html' %}
{% load static %}
{% block title %}Track Order{% endblock title %}

{% block main-content %}
<div class="container my-4">
  <h2 class="mb-4">Track Your Order</h2>
  <div id="map" style="height: 500px; width: 500px; border: 1px solid #ccc;"></div>
</div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Routing Machine -->
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

<script>
  const userLat = {{ user_lat }};
  const userLng = {{ user_lng }};
  const productData = {{ products|safe }};
  const username = "{{ request.user.username|escapejs }}";

  const map = L.map('map').setView([userLat, userLng], 6);

  // Add OpenStreetMap tile layer
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
  }).addTo(map);

  // Mark user's location
  const userMarker = L.marker([userLat, userLng]).addTo(map)
    .bindPopup(`${username}`).openPopup();

  // Loop through products and show route
  productData.forEach(item => {
    const productMarker = L.marker([item.lat, item.lng]).addTo(map)
      .bindPopup(`<strong>${item.title}</strong><br>Status: ${item.status}`);

    // Draw route from product to user
    L.Routing.control({
      waypoints: [
        L.latLng(item.lat, item.lng),
        L.latLng(userLat, userLng)
      ],
      routeWhileDragging: false,
      createMarker: () => null,  // disable default route markers
      show: false
    }).addTo(map);
  });
</script>

{% endblock main-content %}
